<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Minimize Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
        }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .debug-panel h3 {
            color: #ffa500;
            margin-bottom: 10px;
        }
        
        .debug-item {
            margin: 5px 0;
            padding: 5px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        
        .debug-item.error {
            color: #ff4444;
            border-left: 3px solid #ff4444;
        }
        
        .debug-item.success {
            color: #44ff44;
            border-left: 3px solid #44ff44;
        }
        
        .debug-item.warning {
            color: #ffaa44;
            border-left: 3px solid #ffaa44;
        }
        
        .page-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Modal overlay */
        .modal-form-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-form-overlay.active {
            display: block !important;
            opacity: 1 !important;
        }
        
        /* Modal form container */
        .modal-form-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-form-container.active {
            display: block !important;
            opacity: 1 !important;
        }
        
        /* Form header */
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .form-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-title h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .form-controls {
            display: flex;
            gap: 6px;
        }
        
        .btn-control {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 18px;
        }
        
        .btn-control:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .form-content {
            padding: 24px;
        }
        
        /* Footer */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 9998;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .minimized-form-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        
        .minimized-form-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .minimized-form-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .minimized-form-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .minimized-form-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .status-indicator {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 13px;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h3>üîç Debug Console</h3>
        <div id="debugLog"></div>
        <button onclick="clearDebugLog()" style="margin-top: 10px; padding: 5px 10px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear Log</button>
        <button onclick="emergencyRestorePage()" style="margin-top: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">üö® Emergency Restore</button>
    </div>
    
    <!-- Main Content -->
    <div class="page-content">
        <h1>Form Minimize Debug Tool</h1>
        <p>Use this page to test and debug the minimize functionality:</p>
        
        <div style="margin: 20px 0;">
            <button class="test-button" onclick="openTestForm()">
                üìã Open Test Form
            </button>
            <button class="test-button" onclick="checkPageState()">
                üîç Check Page State
            </button>
            <button class="test-button" onclick="emergencyRestorePage()">
                üö® Emergency Restore
            </button>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h2>Instructions:</h2>
            <ol>
                <li>Click "Open Test Form" to open a test form</li>
                <li>Click the minimize button (‚Äî) in the form header</li>
                <li>Watch the debug panel for what happens</li>
                <li>Form should appear in the footer bar at the bottom</li>
                <li>Click the form in the footer or ‚¨ÜÔ∏è to restore it</li>
                <li>Click ‚úï to close it completely</li>
            </ol>
            
            <h3 style="margin-top: 20px;">If page goes blank:</h3>
            <ul>
                <li>Click "Emergency Restore" button</li>
                <li>Check the debug console for errors</li>
                <li>Open browser console (F12) and look for JavaScript errors</li>
            </ul>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h2>Current State:</h2>
            <div id="stateInfo"></div>
        </div>
    </div>
    
    <!-- Test Form -->
    <div class="modal-form-overlay" id="modal-overlay-testForm"></div>
    <div class="modal-form-container" id="testForm">
        <div class="form-header">
            <div class="form-title">
                <span class="form-icon">üìã</span>
                <h3>Test Form</h3>
            </div>
            <div class="form-controls">
                <button type="button" class="btn-control" onclick="minimizeForm('testForm')" title="Minimize">
                    <span>‚Äî</span>
                </button>
                <button type="button" class="btn-control" onclick="closeFormOverlay('testForm')" title="Close">
                    <span>‚úï</span>
                </button>
            </div>
        </div>
        <div class="form-content">
            <p>This is a test form. Click the minimize button (‚Äî) above to test the minimize functionality.</p>
            <p style="margin-top: 10px;">The form should disappear and appear in the footer bar at the bottom of the page.</p>
        </div>
    </div>
    
    <!-- Footer Bar -->
    <div class="footer-bar">
        <div id="minimizedFormsContainer" style="display: flex; gap: 10px; flex: 1;"></div>
        <div class="status-indicator" id="statusIndicator">Ready</div>
    </div>
    
    <!-- Include the bulletproof script -->
     {% load static %}
    <script src="{% static 'common/js/universal_form.js' %}"></script>
    
    <script>
        // Debug logging
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const item = document.createElement('div');
            item.className = `debug-item ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            item.textContent = `[${timestamp}] ${message}`;
            log.appendChild(item);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
            debugLog('Log cleared', 'success');
        }
        
        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            debugLog(args.join(' '), 'success');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            debugLog(args.join(' '), 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            debugLog(args.join(' '), 'warning');
            originalWarn.apply(console, args);
        };
        
        // Test functions
        function openTestForm() {
            debugLog('Opening test form...', 'info');
            document.getElementById('statusIndicator').textContent = 'Form Open';
            openForm('testForm');
        }
        
        function checkPageState() {
            debugLog('=== PAGE STATE CHECK ===', 'info');
            
            const body = document.body;
            const overlay = document.getElementById('modal-overlay-testForm');
            const form = document.getElementById('testForm');
            const footer = document.getElementById('minimizedFormsContainer');
            
            debugLog(`Body display: ${window.getComputedStyle(body).display}`, 'info');
            debugLog(`Body overflow: ${body.style.overflow || 'default'}`, 'info');
            
            if (overlay) {
                debugLog(`Overlay display: ${window.getComputedStyle(overlay).display}`, 'info');
                debugLog(`Overlay opacity: ${window.getComputedStyle(overlay).opacity}`, 'info');
            }
            
            if (form) {
                debugLog(`Form display: ${window.getComputedStyle(form).display}`, 'info');
                debugLog(`Form opacity: ${window.getComputedStyle(form).opacity}`, 'info');
            }
            
            if (footer) {
                debugLog(`Footer container found: Yes`, 'success');
                debugLog(`Minimized forms count: ${footer.children.length}`, 'info');
            } else {
                debugLog(`Footer container found: No`, 'error');
            }
            
            debugLog('=== END STATE CHECK ===', 'info');
        }
        
        // Update status on visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                debugLog('Page hidden', 'warning');
            } else {
                debugLog('Page visible', 'success');
            }
        });
        
        // Initial log
        debugLog('Debug tool initialized', 'success');
        checkPageState();
    </script>
</body>
</html>